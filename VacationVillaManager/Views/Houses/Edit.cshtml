@model VacationVillaManager.Models.House
@using VacationVillaManager.Models;

@{
    ViewBag.Title = "Edit";
}

@Styles.Render("~/Content/BootstrapOverride.css")

<!-- Begin slideshow scaffolding -->

<div id="modal-gallery" class="modal modal-gallery hide fade" tabindex="-1">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">&times;</a>
        <h3 class="modal-title"></h3>
    </div>
    <div class="modal-body"><div class="modal-image"></div></div>
    <div class="modal-footer">
        <a class="btn modal-download" target="_blank"><i class="icon-download"></i> Download</a>
        <a class="btn btn-success modal-play modal-slideshow" data-slideshow="5000"><i class="icon-play icon-white"></i> Slideshow</a>
        <a class="btn btn-info modal-prev"><i class="icon-arrow-left icon-white"></i> Previous</a>
        <a class="btn btn-primary modal-next">Next <i class="icon-arrow-right icon-white"></i></a>
    </div>
</div>

<!-- End -->

@using (Html.BeginForm())
{
    @Html.ValidationSummary(true)

    @Html.HiddenFor(model => model.ID, new { id = "houseID" })

    <div class="control-group">
        <div class="controls">
            <div class="row-fluid">
                <div class="span6">
                    <h3><a href="@Url.Action("Index")" class="back-button"><i class="icon-circle-arrow-left"></i></a> <a href="#" id="name-editable">@Html.DisplayFor(model => model.Name)</a></h3>
                    @Html.HiddenFor(model => model.Name, new { id = "house-name" })
                </div>
            </div>
        </div>
    </div>
    <div class="control-group center">
        <div class="controls">
            <div class="row-fluid">
                <div class="span4 well well-small">
                    <fieldset>
                        <legend>Contact Information</legend>
                        <div class="btn-group contact-select" data-toggle="buttons-radio">
                            <button type="button" id="btnHome" class="btn">Home</button>
                            <button type="button" id="btnOwner" class="btn">Owner</button>
                            <button type="button" id="btnManagement" class="btn">Management</button>
                        </div>
                        <div class="homeEditor">
                            @Html.HiddenFor(model => model.Location.ID)
                            @Html.EditorFor(model => model.Location)

                            <div class="input-prepend">
                                <span class="add-on"><i class="icon-phone"></i></span>
                                @Html.TextBoxFor(model => model.PhoneNumber, new { placeholder = "Phone Number" })
                            </div>

                            <div class="input-prepend">
                                <span class="add-on"><i class="icon-lock"></i></span>
                                @Html.TextBoxFor(model => model.SecurityCode, new { placeholder = "Door/Security Code" })
                            </div>
                        </div>
                        <div class="ownerEditor" style="display: none;">
                            @Html.HiddenFor(model => model.Owner.ID)
                            @Html.EditorFor(model => model.Owner)
                        </div>
                        <div class="managementEditor" style="display: none;">
                            @Html.HiddenFor(model => model.ManagementCompany.ID)
                            @Html.EditorFor(model => model.ManagementCompany)
                        </div>
                    </fieldset>
                </div>
                <div class="span4 well well-small">
                    <fieldset>
                        <legend>Rate Information</legend>
                        <div class="input-prepend input-append">
                            <span class="add-on"><i class="icon-usd"></i></span>
                            @Html.TextBoxFor(model => model.Rate, new { placeholder = "Rate", @class = "input-mini" })
                            <span class="add-on">Per Day</span>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Costs <a href="javascript:void(0)" class="add-button addNewCost" onclick="@{Model.Costs.Add(new Cost());}"><i class="icon-plus-sign"></i></a></legend>
                        <div class="costEditor">
                            @for (int i = 0; i < Model.Costs.Count - 1; i ++)
                            {
                                <div class="costEditorRow" id="@i">
                                    @Html.EditorFor(model => model.Costs[i])
                                </div>
                            }

                            <!-- Generated cost editors go here -->
                        </div>
                    </fieldset>
                </div>
                <div class="span4 well well-small">
                    <div class="legend-mimick">Photos <a href="javascript:void(0)" id="photo-button" class="addNewPhoto"><i class="icon-picture"></i></a></div>
                    <div id="upload-info">
                        <div id="gallery" data-toggle="modal-gallery" data-target="#modal-gallery">
                            <ul class="thumbnails">
                                @for (int i = 0; i < Model.Photos.Count; i ++)
                                {
                                    <li class="span3">
                                        <a href="@Model.Photos[i].URL" class="thumbnail" title="@Model.Photos[i].Name" data-gallery="gallery"><img id="photo-@i" src="@Model.Photos[i].URLThumb" /></a>
                                        @Html.HiddenFor(model => Model.Photos[i].ID)
                                        @Html.HiddenFor(model => Model.Photos[i].Name)
                                        @Html.HiddenFor(model => Model.Photos[i].URL)
                                        @Html.HiddenFor(model => Model.Photos[i].URLThumb)
                                    </li>
                                }

                                <!-- Image thumbnails go here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row-fluid">
        <div class="span12 well well-small">
            <div class="row-fluid">
                <div class="offset1">
                    <label for="save-changes" class="btn btn-large btn-primary"><i class="icon-ok"></i>  Save</label>
                    <input type="submit" value="Save" id="save-changes" class="hidden" />
                </div>
            </div>
        </div>
    </div>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/Scripts/editable/js/bootstrap-editable.js")
    @Styles.Render("~/Scripts/editable/css/bootstrap-editable.css")
    @Scripts.Render("http://blueimp.github.com/JavaScript-Load-Image/load-image.min.js")
    @Scripts.Render("~/Scripts/slideshow/js/bootstrap-image-gallery.js")
    @Styles.Render("~/Scripts/slideshow/css/bootstrap-image-gallery.css")
    @Scripts.Render("~/Scripts/uploader/fileuploader.js")
    @Styles.Render("~/Scripts/uploader/fileuploader.css")

    <script type="text/javascript">
        $(document).ready(function () {

            var id = @Model.Costs.Count - 2;
            var houseID = $('#houseID').val();
            var buttonActive = 0;
            var photoID = @Model.Photos.Count +0;
            //alert(photoID);

            var qqupload = new qq.FileUploaderBasic({
                button: document.getElementById('photo-button'),
                action: '@Url.Action("PhotoUpload", "Bookings")',
                onUpload: function (id, filename, xhr) {
                    var toAppend = '<li class="span3"><a href="#" class="thumbnail" title="' + filename + '" data-gallery="gallery"><img id=photo' + id + ' src="/Scripts/uploader/loading.gif" /></a></li>';
                    $('.thumbnails').append(toAppend);
                },
                onComplete: function (id, filename, responseJSON) {
                    @{Model.Photos.Add(new Photo());}
                    var toAppend = '<input type="hidden" name="Photos[' + photoID + '].ID" value="0" />';
                    $('#upload-info').append(toAppend);
                    var toAppend = '<input type="hidden" name="Photos[' + photoID + '].URL" value="' + responseJSON.path + '" />';
                    $('#upload-info').append(toAppend);
                    var toAppend = '<input type="hidden" name="Photos[' + photoID + '].URLThumb" value="' + responseJSON.thumb + '" />';
                    $('#upload-info').append(toAppend);
                    var toAppend = '<input type="hidden" name="Photos[' + photoID + '].Name" value="' + responseJSON.name + '" />';
                    $('#upload-info').append(toAppend);

                    $('#photo' + id + '').attr("src", responseJSON.thumb);
                    $('#photo' + id + '').parent().attr("href", responseJSON.path);

                    photoID++;
                },
                params: {
                    houseID: '0'
                }
            });

            $('#photo-button').click(function () {
                $('#upload-input').click();
            });

            /*$.ajax({
                type: "GET",
                url: "/Bookings/GetCosts/" + houseID,
                success: function ($result) {

                    var currentPos = id;
                    $.each($result.Costs, function (index, cost) {
                        id++;
                        $.ajax({
                            type: "GET",
                            url: "/Houses/_CostEditorWithID/" + id,
                            async: false,
                            success: function ($result2) {
                                var toInject = $result2;
                                $('.costEditor').append(toInject);
                                $('.costEditor').find('.costEditorRow:last').slideDown();

                                currentPos++;

                                $('#' + currentPos + ' .costName').val(cost.Name);
                                $('#' + currentPos + ' .costAmount').val(cost.Amount);
                                $('#' + currentPos + ' .costID').val(cost.ID);
                            }
                        });
                    });
                }
            });*/



            $.fn.editable.defaults.mode = 'inline';

            $('#name-editable').editable({
                type: 'text',
                title: 'Enter name'
            });

            $('#name-editable').on('save', function (e, params) {
                $('#house-name').val(params.newValue);
            });

            $('#btnHome').button('toggle');

            $('#btnHome').click(function () {
                if (buttonActive == 1) {
                    $('.ownerEditor').slideUp('default', function () {
                        $('.homeEditor').slideDown();
                        buttonActive = 0;
                    });
                }

                else if (buttonActive == 2) {
                    $('.managementEditor').slideUp('default', function () {
                        $('.homeEditor').slideDown();
                        buttonActive = 0;
                    });
                }
            });

            $('#btnOwner').click(function () {
                if (buttonActive == 0) {
                    $('.homeEditor').slideUp('default', function () {
                        $('.ownerEditor').slideDown();
                        buttonActive = 1;
                    });
                }

                else if (buttonActive == 2) {
                    $('.managementEditor').slideUp('default', function () {
                        $('.ownerEditor').slideDown();
                        buttonActive = 1;
                    });
                }
            });

            $('#btnManagement').click(function () {
                if (buttonActive == 0) {
                    $('.homeEditor').slideUp('default', function () {
                        $('.managementEditor').slideDown();
                        buttonActive = 2;
                    });
                }

                else if (buttonActive == 1) {
                    $('.ownerEditor').slideUp('default', function () {
                        $('.managementEditor').slideDown();
                        buttonActive = 2;
                    });
                }
            });

            $('.addNewCost').click(function () {
                id++;
                $.ajax({
                    type: "GET",
                    url: "/Houses/_CostEditorWithID/" + id,
                    success: function ($result) {
                        var toInject = $result;
                        $('.costEditor').append(toInject);
                        $('.costEditor').find('.costEditorRow:last').slideDown();
                        $('#' + id + ' .costID').val(0);
                    }
                });
            });

            /*$("a.deleteRow").live("click", function () {
                //$(this).parents("div.costEditorRow:first").remove();
                var divId = $(this).closest('div').attr('id');
                $('#' + divId + ' .costName').val('');
                $('#' + divId + ' .costAmount').val('');
                $(this).parents("div.costEditorRow:first").hide();
                return false;
            });*/

            $('body').on('click', 'a.deleteRow', function () {
                var divId = $(this).parents("div.costEditorRow:first").attr('id');

                $(this).parents("div.costEditorRow:first").slideUp('default', function () {
                    $('#' + divId + ' .costName').val('');
                    $('#' + divId + ' .costAmount').val('');
                });
                return false;
            });
        });
    </script>
}
